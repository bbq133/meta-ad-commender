# Meta广告Action分析系统 - 功能修改说明

## 修改日期
2024-12-26

## 修改概述
根据会议纪要要求，对Ads Commander系统的KPI计算逻辑进行了重大更新，主要涉及投放周期设置和生意大盘（Business Outcome）模块的计算公式调整。

---

## 一、新增功能：投放周期设置

### 1.1 配置位置
**配置中心（Configuration Center）** → **业务线配置管理**

### 1.2 新增字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| Campaign Period | DateRange | 投放周期设置（开始日期 - 结束日期） |

### 1.3 功能说明
- **开始日期**：投放周期的起始日期（YYYY-MM-DD格式）
- **结束日期**：投放周期的结束日期（YYYY-MM-DD格式）
- **作用范围**：
  - GMV Achievement的目标值和达成率计算
  - ACOS的Target Line和溢出比例计算
  - Progress Metrics中的Time Progress计算
- **默认值**：如未设置，使用全局日期筛选器的日期范围

---

## 二、GMV Achievement 计算逻辑修改

### 2.1 修改前
```typescript
// 基于配置的ROI目标反推GMV
configs.forEach(config => {
  if (config.targetType === 'ROI') {
    targetGMV += config.budget * config.targetValue;
  }
});

// 达成率
achievementRate = 当前GMV / 目标GMV
```

### 2.2 修改后
```typescript
// Target（目标值）= 所有预算总和
const targetGMV = configs.reduce((sum, config) => sum + config.budget, 0);

// 达成率计算
const gmvAchievementRate = (总成交额 / targetGMV) * 100;
```

### 2.3 核心变化
| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| **Target定义** | 基于ROI目标反推的GMV | 所有预算总和 |
| **计算公式** | 当前GMV / (预算 × ROI目标) | 总成交额 / 所有预算总和 × 100% |
| **业务含义** | 相对于ROI目标的GMV完成度 | 相对于投入预算的收入倍数 |

### 2.4 示例对比
**假设配置：**
- 配置1：预算 $5,000，ROI目标 4.5x
- 配置2：预算 $3,000，ROI目标 3.0x
- 配置3：预算 $12,000，ROI目标 2.8x
- 总预算：$20,000
- 实际GMV：$45,000

**修改前：**
```
目标GMV = 5000×4.5 + 3000×3.0 + 12000×2.8 = 64,100
达成率 = 45,000 / 64,100 = 70.2%
```

**修改后：**
```
Target = 20,000（所有预算总和）
达成率 = (45,000 / 20,000) × 100% = 225%
```

---

## 三、ACOS 计算逻辑修改

### 3.1 修改前
```typescript
// ACOS计算（小数形式）
const acos = spend / purchase_value;

// 目标ACOS（加权平均）
const targetAcos = configs.reduce((sum, config) => {
  if (config.targetType === 'ROI') {
    return sum + (1 / config.targetValue) * config.budget;
  }
  return sum;
}, 0) / totalBudget;

// 偏离度
const deviation = (实际ACOS - 目标ACOS) * 100;
```

### 3.2 修改后
```typescript
// ACOS计算（百分比形式）
const acos = (总Spend / GMV) * 100%;

// Target Line计算
let weightedRoiSum = 0;
let totalBudget = 0;

configs.forEach(config => {
  if (config.targetType === 'ROI') {
    weightedRoiSum += config.budget * config.targetValue;
    totalBudget += config.budget;
  }
});

const targetLine = (totalBudget / weightedRoiSum) * 100%;

// 达成率
const acosAchievementRate = (总成交额 / 所有预算总和) * 100%;

// 溢出比例
const acosDeviation = 实际ACOS - Target Line;
```

### 3.3 核心变化
| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| **ACOS格式** | 小数（0.25） | 百分比（25%） |
| **Target计算** | 加权平均ACOS | Target Line = 总预算 / 加权GMV目标 |
| **达成率** | 无 | 总成交额 / 所有预算总和 × 100% |
| **偏离度名称** | Deviation | 溢出比例（Deviation） |
| **偏离度公式** | (实际-目标) × 100 | 实际ACOS - Target Line |

### 3.4 示例对比
**假设数据：**
- 总Spend：$10,000
- 总GMV：$40,000
- 配置同上（总预算$20,000，加权ROI目标）

**修改前：**
```
实际ACOS = 10,000 / 40,000 = 0.25
目标ACOS = [(1/4.5)×5000 + (1/3.0)×3000 + (1/2.8)×12000] / 20,000 = 0.30
偏离度 = (0.25 - 0.30) × 100 = -5%
```

**修改后：**
```
实际ACOS = (10,000 / 40,000) × 100% = 25%
加权GMV目标 = 5000×4.5 + 3000×3.0 + 12000×2.8 = 64,100
Target Line = (20,000 / 64,100) × 100% = 31.2%
达成率 = (40,000 / 20,000) × 100% = 200%
溢出比例 = 25% - 31.2% = -6.2%（绿色，成本控制良好）
```

---

## 四、Progress Metrics 修改

### 4.1 Time Progress 计算更新
```typescript
// 修改前：使用全局日期筛选器
const timeProgress = (当前时间 - 开始日期) / (结束日期 - 开始日期);

// 修改后：优先使用投放周期配置
const campaignStartDate = config.campaignPeriod?.startDate || startDate;
const campaignEndDate = config.campaignPeriod?.endDate || endDate;

const timeProgress = (Date.now() - new Date(campaignStartDate).getTime()) / 
                     (new Date(campaignEndDate).getTime() - new Date(campaignStartDate).getTime());
```

### 4.2 Cycle Progress 说明优化
| 状态 | 范围 | 颜色 | 说明 |
|------|------|------|------|
| 消耗过快 | > 5% | 红色 | 预算可能提前耗尽 |
| 消耗过慢 | < -5% | 黄色 | 可能无法完成目标 |
| 进度健康 | -5% ~ 5% | 绿色 | 消耗与时间匹配 |

---

## 四、数据筛选范围限定

### 4.1 业务线筛选器作用范围
**重要变更**：业务线筛选器（Configuration Filter）**不对生意大盘（OverviewTab）生效**。

### 4.2 筛选范围说明
| 模块 | 是否受筛选影响 | 说明 |
|------|--------------|------|
| 生意大盘（OverviewTab） | ❌ 否 | 始终显示全量数据，确保管理层看到账户整体健康状况 |
| 业务详情（BusinessLineTab） | ✅ 是 | 根据选中的业务线配置动态筛选 |
| 执行诊断（ExecutionTab） | ✅ 是 | 根据选中的业务线配置动态筛选 |
| 投放策略（QuadrantTab） | ✅ 是 | 根据选中的业务线配置动态筛选 |
| 待办清单（TodoTab） | ✅ 是 | 仅显示筛选后模块添加的任务 |

### 4.3 数据流分支
```typescript
// OverviewTab: 仅应用日期筛选
const overviewData = useMemo(() => {
  return data.filter(r => {
    const datePart = r.date.includes(' ') ? r.date.split(' ')[0] : r.date;
    const d = new Date(datePart + 'T00:00:00').getTime();
    return d >= startMs && d <= endMs; // 仅日期筛选，不应用配置筛选
  });
}, [data, startDate, endDate]);

// 其他Tab: 应用日期筛选 + 配置筛选
const filteredData = useMemo(() => {
  return data.filter(r => {
    // 1. 日期筛选
    const datePart = r.date.includes(' ') ? r.date.split(' ')[0] : r.date;
    const d = new Date(datePart + 'T00:00:00').getTime();
    const dateMatch = d >= startMs && d <= endMs;
    if (!dateMatch) return false;
    
    // 2. 配置筛选（仅非OverviewTab）
    if (selectedConfigIds.length === 0) return true;
    const activeConfigs = configs.filter(c => selectedConfigIds.includes(c.id));
    return activeConfigs.some(config => matchesConfig(r, config)); // OR逻辑
  });
}, [data, startDate, endDate, selectedConfigIds, configs]);
```

### 4.4 设计理由
1. **全局视角**：生意大盘需要展示账户的整体表现，不应受业务线筛选影响
2. **决策支持**：管理层需要基于全量数据做出预算分配和策略调整决策
3. **数据一致性**：GMV Achievement、ACOS等核心KPI应基于全账户数据计算
4. **用户体验**：避免用户因筛选配置导致生意大盘数据异常波动

---

## 五、业务详情（BusinessLineTab）功能重构

### 5.1 功能调整概述
**重要变更**：业务详情Tab进行了重大功能重构，移除了部分图表，引入四象限策略分析。

### 5.2 KPI选择器调整

#### 修改前
```
- GMV（purchase_value）：总成交额
- ROI Efficiency（roi）：投资回报率
- CPC Cost（cpc）：点击成本
- Global CPM（cpm）：千次展示成本
```

#### 修改后
```
- ROI Efficiency（roi）：投资回报率
- CPC Cost（cpc）：点击成本
- Global CPM（cpm）：千次展示成本
```

**变更原因**：
- GMV作为核心业务指标，统一在生意大盘（OverviewTab）中查看
- 业务详情聚焦于效率分析（ROI、CPC、CPM）
- 避免指标重复展示，提升用户体验

### 5.3 图表功能调整

#### 移除的功能
1. **Campaign Ranking（排名图表）**
   - 水平柱状图
   - Top 10 Campaign排名
   - 排序功能

2. **Efficiency Analysis（效率散点图）**
   - 基础散点图
   - 简单的颜色分类（绿色/红色）

#### 新增的功能
**四象限策略分析（Quadrant Analysis）**

##### 核心特性
- 基于Spend（X轴）和选定KPI（Y轴）的四象限划分
- 动态阈值控制器（可调节X/Y轴分界线）
- 智能策略建议（根据象限自动生成）
- 象限统计卡片（汇总展示）

##### 四象限定义

**ROI模式：**
| 象限 | 定义 | 策略 | 颜色 |
|------|------|------|------|
| Q1 - Stars | 高消耗 + 高ROI | Scale Budget (加速扩量) | 绿色 |
| Q2 - Potential | 低消耗 + 高ROI | Increase Volume (提价拓量) | 靛蓝 |
| Q3 - Fixers | 高消耗 + 低ROI | Funnel Optimization (优化转化) | 黄色 |
| Q4 - Wasters | 低消耗 + 低ROI | Pause & Re-evaluate (关停并重审) | 红色 |

**CPC/CPM模式：**
| 象限 | 定义 | 策略 | 颜色 |
|------|------|------|------|
| Q1 - Efficient | 高消耗 + 低成本 | 维持并扩量 | 绿色 |
| Q2 - Potential | 低消耗 + 低成本 | 加大投入测试 | 靛蓝 |
| Q3 - Expensive | 高消耗 + 高成本 | 优化出价策略 | 黄色 |
| Q4 - Inefficient | 低消耗 + 高成本 | 考虑暂停 | 红色 |

### 5.4 数据粒度变化
- **修改前**：adset_name（广告组级别）
- **修改后**：Campaign（系列级别）
- **原因**：系列级别更适合战略决策，与业务线配置对齐

### 5.5 交互功能增强
1. **阈值控制器**
   - Volume (Spend X)：滑动条调节消耗分界线
   - Efficiency (Y轴)：根据KPI类型动态调整
   
2. **象限统计卡片**
   - 每个象限的项目数量
   - 总消耗金额汇总
   - 平均KPI值
   - 快速操作按钮

3. **散点图交互**
   - 点击气泡定位到详情表格
   - 选中项高亮显示
   - 悬停显示详细数据

### 5.6 UI布局变化

**修改前：**
```
[KPI选择器: GMV | ROI | CPC | CPM]
┌─────────────────────────────────────┐
│  Campaign Ranking (柱状图)          │
│  Top 10排名                         │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│  Efficiency Analysis (散点图)       │
│  简单颜色分类                       │
└─────────────────────────────────────┘
[详情表格]
```

**修改后：**
```
[KPI选择器: ROI | CPC | CPM]
┌─────────────────────────────────────┐
│  四象限策略分析 (Quadrant Analysis) │
│  ┌─────────────┬─────────────┐      │
│  │ Q2-Potential│ Q1-Stars    │      │
│  ├─────────────┼─────────────┤      │
│  │ Q4-Wasters  │ Q3-Fixers   │      │
│  └─────────────┴─────────────┘      │
│  [阈值控制器: Spend X | KPI Y]      │
└─────────────────────────────────────┘
┌──────┬──────┬──────┬──────┐
│ Q1卡片│ Q2卡片│ Q3卡片│ Q4卡片│
└──────┴──────┴──────┴──────┘
[详情表格]
```

## 七、UI展示变化

### 7.1 GMV Achievement 卡片
**修改前：**
```
Revenue (总成交额)
$45,000
GMV Achievement: 70.2%
Target: $64,100
```

**修改后：**
```
Revenue (总成交额) / GMV Achievement
$45,000
达成率: 225%
Target: $20,000 (所有预算总和)
```

### 7.2 ACOS 卡片
**修改前：**
```
ACOS (销售费率)
0.25
Deviation: -5%
Goal: 0.30
```

**修改后：**
```
ACOS (销售费率)
25.0%
Target Line: 31.2%
达成率: 200%
溢出比例: -6.2% (绿色)
```

---

## 八、数据模型更新

### 8.1 AdConfiguration 接口扩展
```typescript
export interface AdConfiguration {
  id: string;
  name: string;
  level: 'Campaign' | 'AdSet' | 'Ad';
  budget: number;
  targetType: 'ROI' | 'CPC' | 'CPM';
  targetValue: number;
  rules: FilterRule[];
  
  // 新增字段
  campaignPeriod?: {
    startDate: string;  // YYYY-MM-DD
    endDate: string;    // YYYY-MM-DD
  };
}
```

---

## 九、影响范围总结

### 9.1 直接影响的模块
1. **配置中心（Configuration Center）**
   - 新增投放周期设置UI
   - 新增日期选择器组件

2. **生意大盘（OverviewTab）**
   - GMV Achievement计算逻辑
   - ACOS计算逻辑
   - Progress Metrics计算逻辑
   - **数据筛选逻辑**：不应用业务线筛选器

3. **业务详情（BusinessLineTab）**
   - **KPI选择器**：移除GMV选项
   - **图表功能**：移除Campaign Ranking和Efficiency Analysis
   - **新增功能**：四象限策略分析
   - **数据粒度**：从adset_name改为Campaign
   - **数据筛选逻辑**：应用业务线筛选器

4. **其他三个模块**
   - ExecutionTab / QuadrantTab / TodoTab
   - **数据筛选逻辑**：应用业务线筛选器

### 9.2 间接影响的模块
1. **数据聚合层（calculateMetrics）**
   - ACOS返回格式从小数改为百分比

2. **格式化工具（formatPercent）**
   - 需要适配ACOS的百分比显示

3. **图表组件**
   - GMV Achievement进度条的目标值更新
   - ACOS卡片的展示格式调整
   - BusinessLineTab新增四象限散点图组件
   - BusinessLineTab新增象限统计卡片组件

4. **数据流管理（useMemo）**
   - 新增overviewData和filteredData两个独立数据流
   - BusinessLineTab数据粒度从adset改为campaign

---

## 十、测试建议

### 10.1 单元测试
- [ ] GMV Achievement计算准确性
- [ ] ACOS百分比格式转换
- [ ] Target Line计算逻辑
- [ ] 投放周期配置的默认值处理
- [ ] **OverviewTab数据筛选逻辑（仅日期筛选）**
- [ ] **其他Tab数据筛选逻辑（日期+配置筛选）**
- [ ] **BusinessLineTab四象限划分逻辑**
- [ ] **BusinessLineTab阈值控制器计算**

### 10.2 集成测试
- [ ] 配置中心保存投放周期
- [ ] 生意大盘各指标联动更新
- [ ] 日期筛选器与投放周期的优先级
- [ ] **业务线筛选器对OverviewTab无影响**
- [ ] **业务线筛选器对其他Tab正常生效**
- [ ] **BusinessLineTab KPI切换功能**
- [ ] **BusinessLineTab四象限图与详情表格联动**
- [ ] **BusinessLineTab象限统计卡片数据准确性**

### 10.3 边界测试
- [ ] 无配置时的默认行为
- [ ] 投放周期未设置时的降级逻辑
- [ ] GMV为0时的除零保护
- [ ] 预算为0时的处理
- [ ] **选中所有配置vs无配置的数据一致性**
- [ ] **BusinessLineTab无Campaign数据时的空状态**
- [ ] **BusinessLineTab阈值边界值测试**

---

## 十一、迁移指南

### 11.1 数据迁移
现有配置无需迁移，`campaignPeriod`字段为可选，未设置时自动使用全局日期筛选器。

### 11.2 代码迁移
```typescript
// 旧代码
const targetGMV = configs.reduce((sum, config) => {
  if (config.targetType === 'ROI') {
    return sum + config.budget * config.targetValue;
  }
  return sum;
}, 0);

// 新代码
const targetGMV = configs.reduce((sum, config) => sum + config.budget, 0);
```

```typescript
// 旧代码
const acos = spend / purchase_value;

// 新代码
const acos = (spend / purchase_value) * 100;
```

```typescript
// 新增：OverviewTab独立数据流
const overviewData = useMemo(() => {
  return data.filter(r => {
    const datePart = r.date.includes(' ') ? r.date.split(' ')[0] : r.date;
    const d = new Date(datePart + 'T00:00:00').getTime();
    return d >= startMs && d <= endMs; // 仅日期筛选
  });
}, [data, startDate, endDate]);
```

```typescript
// 新增：BusinessLineTab数据粒度调整
// 旧代码：adset级别
const adsetData = data.filter(r => r.adset_name === selectedAdset);

// 新代码：campaign级别
const campaignData = data.filter(r => r.campaign_name === selectedCampaign);
```

---

## 十二、文档更新清单

- [x] Meta广告action分析系统PRD.md - 配置中心章节
- [x] Meta广告action分析系统PRD.md - GMV Achievement计算逻辑
- [x] Meta广告action分析系统PRD.md - ACOS计算逻辑
- [x] Meta广告action分析系统PRD.md - Progress Metrics章节
- [x] Meta广告action分析系统PRD.md - 业务线筛选器作用范围
- [x] Meta广告action分析系统PRD.md - 数据流分支逻辑
- [x] Meta广告action分析系统PRD.md - BusinessLineTab功能重构
- [x] 功能修改说明.md - 数据筛选范围限定章节
- [x] 功能修改说明.md - BusinessLineTab功能重构章节
- [ ] API文档 - AdConfiguration接口定义
- [ ] 用户手册 - 投放周期设置说明
- [ ] 开发文档 - 计算公式变更说明
- [ ] UI设计稿 - BusinessLineTab四象限图组件
- [ ] UI设计稿 - BusinessLineTab象限统计卡片

---

**修改完成日期**：2024-12-26  
**文档版本**：v2.2  
**修改人**：Product Team
