# 智能预算计算功能说明

## 📋 功能概述

实现了**方案 4：智能预算计算**，根据业务线的投放周期和用户选择的日期范围，动态计算应分配预算，使 Spend Pacing 指标更加准确。

---

## 🎯 核心逻辑

### 1. 日均预算计算
```
日均预算 = 业务线总预算 / 投放总天数
```

### 2. 重叠区间计算
- 计算投放周期与选择日期的重叠部分
- 重叠开始日期 = max(投放开始日期, 选择开始日期)
- 重叠结束日期 = min(投放结束日期, 选择结束日期)

### 3. 应分配预算计算
```
应分配预算 = 日均预算 × 重叠天数
```

### 4. 总预算汇总
```
总预算 = Σ(所有业务线的应分配预算)
```

---

## 📊 业务场景示例

### 场景 1：完全重叠
```
业务线 AO:
├─ 总预算: $5,000
├─ 投放周期: 12/01 - 12/31 (31天)
└─ 日均预算: $161.29/天

用户选择: 12/25 - 12/27 (3天)
├─ 重叠情况: 完全重叠 ✅
├─ 重叠天数: 3天
└─ 应分配预算: $161.29 × 3 = $483.87
```

### 场景 2：部分重叠
```
业务线 AI:
├─ 总预算: $3,000
├─ 投放周期: 12/15 - 01/15 (32天)
└─ 日均预算: $93.75/天

用户选择: 12/25 - 12/27 (3天)
├─ 重叠情况: 完全重叠 ✅
├─ 重叠天数: 3天
└─ 应分配预算: $93.75 × 3 = $281.25
```

### 场景 3：不重叠
```
业务线 BlackFriday:
├─ 总预算: $10,000
├─ 投放周期: 11/25 - 11/30
└─ 日均预算: $1,666.67/天

用户选择: 12/25 - 12/27
├─ 重叠情况: 完全不重叠 ❌
└─ 应分配预算: $0
```

### 总计
```
总应分配预算 = $483.87 + $281.25 + $0 = $765.12
实际花费: $720.00
Spend Pacing = $720 / $765.12 = 94.1%
```

---

## 🔧 技术实现

### 新增工具函数（dataUtils.ts）

1. **getDaysDiff(startDate, endDate)**
   - 计算两个日期之间的天数差（包含首尾两天）

2. **getOverlapPeriod(period1Start, period1End, period2Start, period2End)**
   - 计算两个日期区间的重叠部分
   - 返回重叠的开始日期、结束日期和天数

3. **calculateConfigBudget(config, selectedStart, selectedEnd)**
   - 计算单个业务线在指定时间段内的应分配预算
   - 返回：allocatedBudget, dailyBudget, overlapDays

4. **calculateTotalBudget(configs, selectedStart, selectedEnd)**
   - 计算所有业务线的总预算
   - 返回：totalBudget 和详细的 breakdown 数组

### 更新的组件

1. **OverviewTab.tsx**
   - 添加 startDate 和 endDate props
   - 使用 calculateTotalBudget 替换简单的预算总和
   - 优化 Spend Pacing 卡片显示

2. **App.tsx**
   - 向 OverviewTab 传递日期参数
   - 为默认配置添加投放周期示例

---

## 🎨 UI 优化

### Spend Pacing 卡片显示

**之前**：
```
Spend Pacing
94.6%
Budget: $8,000.00
```

**现在**：
```
Spend Pacing
94.6%
计划: $765.12 | 实际: $720.00 | 2个业务线活跃
```

### 显示内容说明
- **计划**：根据投放周期和选择日期计算的应分配预算
- **实际**：当前时间段的实际花费
- **活跃业务线**：在选择时间段内有投放的业务线数量

---

## ✅ 优势

1. **准确性**：预算计算基于实际投放周期，避免虚高或虚低
2. **灵活性**：自动处理完全重叠、部分重叠、不重叠等各种情况
3. **可追溯**：budgetBreakdown 提供每个业务线的详细预算信息
4. **智能化**：自动排除不相关的业务线，聚焦当前分析
5. **可扩展**：支持未来添加更多业务规则

---

## 📝 使用说明

### 配置业务线投放周期

在 Business Lines 配置中为每个业务线设置投放周期：

```typescript
{
    id: '1',
    name: 'AO',
    budget: 5000,
    targetType: 'ROI',
    targetValue: 4.5,
    campaignPeriod: {
        startDate: '2025-12-01',  // 投放开始日期
        endDate: '2025-12-31'      // 投放结束日期
    }
}
```

### 查看预算明细

系统会自动计算并在控制台输出详细的预算分解信息（可在浏览器开发者工具中查看）。

---

## 🚀 后续优化建议

1. **添加 Tooltip**：鼠标悬停在 Spend Pacing 卡片上显示每个业务线的预算明细
2. **可视化展示**：添加预算执行进度条，显示各业务线的贡献
3. **预警机制**：当某个业务线的花费进度异常时高亮提示
4. **导出功能**：支持导出预算分析报告
5. **历史对比**：对比不同时间段的预算执行情况

---

## 📅 更新日期

2025-12-28

## 👤 实现者

Antigravity AI Assistant
